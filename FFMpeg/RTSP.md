## RTSP

​     RTSP(Real-Time Stream Protocol)是一种**基于文本的多媒体播放控制协议，属于应用层**。和HTTP类似，使用TCP传输，RTSP主要完成媒体信息交互，确认媒体传输方式和媒体传输控制，即RTSP负责上层控制，底层音视频传输使用的是其他的协议（RTP协议），RTSP交互过程中会把媒体信息告知对端，这个媒体信息就放在RTSP的payload（负载）中，和HTTP中的payload是一样的，在RTSP中媒体信息，也就是这个payload使用的是SDP协议，SDP协议就是规定了怎么描述媒体源(网络摄像头)包含哪些媒体流(主要是音频和视频)以及这些媒体流参数是怎么样的（音视频编解码参数等）。所以从IPC（网络摄像头）中获取音视频涉主要及到三个协议：RTSP、SDP、RTP。

**rtsp承载与rtp和rtcp之上，rtsp并不会发送媒体数据，而是使用rtp协议传输**

**rtp并没有规定发送方式，可以选择udp发送或者tcp发送**

##### rtp协议原理

**对流媒体数据进行封包并实现媒体流的实时传输，即它按照RPT数据包格式来封装流媒体数据，并利用与它绑定的协议进行数据包的传输。**

RTP在端口号1025到65535之间选择一个未使用的偶数UDP端口号，而在同一次会话中的RTCP则使用下一个基数UDP端口号。RTP默认端口号5004，所以RTCP端口号默认为5005。

##### rtcp协议详解

**RTCP也是用UDP来传送的，但RTCP封装的仅仅是一些控制信息，因而分组很短，所以可以将多个RTCP分组封装在一个UDP包中。RTCP有如下五种分组类型。**

##### RTSP信令

​        RTSP报文格式和HTTP完全一样，只不过里面的值不一样，使用的错误码也是一样，比如200表示请求成功，40x表示客户端错误，50x表示服务端错误，这样RTSP就很好理解了。HTTP有GET、POST等方法，同样RTSP也有自己的方法，RTSP1.0包含如下方法：

|方法	       |方向	    |是否必      |含义
| :----------| :---------- | :-------- | :------ |
|OPTIONS       | C->S	   |否	|获在取服务器支持的方法。|
|DESCRIBE      | C->S	   |否	|向服务器获取URL指定的媒体对象的描述，其中Accept字段指定了描述格式|
|ANNOUNCE      | C->S S->C |否	|当客户端向服务器发送时，表示的是将通过请求 URL 识别的表示描述或者媒体对象提交给服务器 当服务器向客户端发送时，表示的是通知客户端更新会话信息|
|SETUP	       | C->S	  |是	|客户端向服务器请求建立会话并准备传输。请求信息主要包括传输协议和客户端的端口号|
|PLAY	       | C->S	  |是	|客户端主动通知服务器以SETUP指定的机制开始发送数据。其中Range字段指定了播放的起止时间，当多个PLAY请求到达时，服务器会将PLAY请求排成队列，顺序执行，即必须等待第一个PLAY的时间完成后，才会继续处理第二个PLAY消息。|
|PAUSE	       | C->S	  |否	|客户端请求服务器的媒体流传输临时暂停。可以通过Range参数在指定时间点暂停，也可以指定某股流暂停，例如如果指定音频流暂停，则播放将是无音状态|
|RECORD	       | C->S	  |否	|RECORD通知服务器方法客户端将会根据之前的描述开始记录媒体数据。 其中timestamp 字段反映开始和结束时间 (UTC)。如果该字段不存在，则会使用媒体描述中的开始或结束时间。 如果会话已经开始，则立即开始录制。服务器决定是将记录的数据存储在 request-URI 下还是另一个 URI 下。 如果服务器不使用 request-URI，则响应应该是 201（已创建）并包含描述请求状态并引用新资源的实体和 Location 标头。|
|REDIRECT      | S->C	  |否	|重定向请求通知客户端它必须连接到另一个服务器位置。 它包含强制标头 Location，它指示客户端应该发出对该 URL 的请求。 它可能包含参数Range，表示重定向何时生效。 如果客户端想要继续发送或接收此 URI 的媒体，客户端必须为当前会话发出 TEARDOWN 请求，并在指定主机上为新会话发出SETUP。|
|GET_PARAMETER | C->S S->C |否	|GET_PARAMETER 请求检索 URI 中指定的表示或流的参数值。 回复和响应的内容留给实现。 没有实体主体的 GET_PARAMETER 可用于测试客户端或服务器的活跃度（“ping”）。|
|SET_PARAMETER | C->S S->C |否	|这个方法请求设置演示或URL指定流的参数值。请求仅应包含单个参数，允许客户端决定某个特殊请求为何失败。如请求包含多个参数，所有参数可成功设置，服务器必须只对该请求起作用。服务器必须允许参数可重复设置成同一值，但不让改变参数值。注意：媒体流传输参数必须用SETUP命令设置。将设置传输参数限制为SETUP有利于防火墙。|
|TEARDOWN      | C->S	   |是	|TEARDOWN请求停止给定URL流发送，释放相关资源。|
​    RTSP是C/S模型，RTSP服务端可向RTSP客户端发送音视频(客户端拉流模式)，也可接受来自RTSP客户端发送过来的音视频流(客户端推流模式)，RTSP拉流模式使用的方法包括DESCRIBE、SETUP、PLAY。RTSP推流模式使用的方法包括ANNOUNCE、SETUP、RECORD。其他的方法都是推流模式和拉流模式通用的。一般RTSP使用的都是拉流模式，即IPC作为RTSP服务端，RTSP客户端通过DESCRIBE、SETUP、PLAY等方法从IPC拉取音视频流。客户端推流一般使用另外一种协议RTMP，RTMP本系列中不会介绍。RTSP拉流模式和推流模式，基本类似，推拉流模式只是媒体流向不同，使用的方法不同，其他大同小异。本文主要对拉流模式也是目前IPC的音视频传输都在用的模式进行详细介绍。

RTSP是交互媒体信息，确定数据传输方式的。其中传输方式包括TCP和UDP，UDP又包括单播和组播

##### 1、单播：UDP

##### 2、组播：UDP

​    组播需要RTSP服务器支持才行，服务器的组播地址会记录在SDP中，组播与单播相比，DESCRIBE和SETUP不同。    

##### 3、RTP OVER TCP/RTSP

​         当使用TCP协议承载RTSP/RTP时，所有的命令和媒体数据都将通过RTSP端口，RTP数据发送使用RTSP的socket和端口，数据将经过二元交织格式化之后才能发送。

    要使用TCP连接，RTSP客户端需要在SETUP阶段请求TCP连接。SETUP命令中应该包括如下格式的Transport：

Transport: RTP/AVP/TCP;interleaved=0-1

    上述Transport将告诉服务端使用TCP协议发送媒体数据，并且使用信道 0 和 1 对流数据以及控制信息进行交织。详细说来，使用偶数信道作为数据传输信道，使用奇数信道作为控制信道（数据信道 + 1）。所以，如果你设定数据信道为 0 ，那控制信道应该是 0 + 1 = 1。
    
    RTP，RTCP数据和RTSP数据共享TCP数据通道，所以必须有一个标识来区别三种数据。
    
    RTP和RTCP数据会以$符号＋1个字节的通道编号＋2个字节的数据长度，共4个字节的前缀开始，RTSP数据是没有前缀数据的。RTP数据和RTCP数据的区别在于第二个字节的通道编号，

RTP基于TCP的包头比基于UDP的包头多了4个字节：

* magic固定为0x24，

* channel用来区分音视频等多路流媒体的通道，其中偶数通道为流媒体内容，奇数通道为RTCP

* len表示数据包的长度减去开始的4个字节，即len字段之后的数据长度



#### 总结

一个完整的RTSP流媒体传输过程是：

##### 1、RTSP信令交互阶段：

客户端发起RTSP连接请求到服务端。
服务端响应，建立RTSP连接。
客户端与服务端交互，协商媒体传输方式（例如，使用UDP或TCP）。
服务端确认传输方式，建立媒体传输通道。

##### 2、采集音视频阶段：

服务端开始采集音频和视频数据。

##### 3、音视频编码阶段：

服务端进行H.264/H.265视频编码和AAC/PCM/PCMA/PACMU音频编码。

##### 4、RTP封装阶段：

服务端将编码后的音视频数据封装成RTP数据包。
视频使用H.264/H.265 RTP封装，音频使用AAC/PCM/PCMA/PACMU RTP封装。

##### 5、RTP数据传输阶段：

使用选择的传输方式（UDP或TCP），服务端将RTP数据包发送到客户端。

##### 6、客户端接收与解包阶段：

客户端接收RTP数据包。
如果使用UDP传输，客户端直接解包RTP数据。
如果使用TCP传输，客户端从RTSP信令中获取通道信息，然后通过TCP连接接收RTP数据。

##### 7、解码与播放阶段：

客户端对接收到的音视频数据进行解码。
解码后的数据传递给播放器进行播放。
