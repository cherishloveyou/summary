# Charles抓包原理

为什么手机安装了Charles根证书后就能正常抓包呢？
 其实Charles做的就是针对HTTPS的通信双方身份的真实性进行处理；

- 当客户端和服务器建立连接时，Charles会拦截到服务器返回的证书（服务器公钥）
- 然后动态生成一张weizao证书（Charles公钥/假公钥）发送给客户端
- 客户端收到Charles证书后，进行验证；因为之前我们手机设置了信任，所以验证通过；（只要手机不信任这种证书，HTTPS还是能确保安全的）
- 客户端生成会话密钥，使用Charles证书对会话密钥进行加密再传输给服务器
- Charles拦截到客户端传输的数据，使用自己的Charles私钥进行解密得到会话密钥
- 连接成功后，客户端和服务器通信，客户端对传输的数据使用会话密钥加密并使用公钥对数据摘要进行数字签名，一同传输给服务器；
- Charles拦截到通信的数据，使用之前获得的会话密钥解密就能得到原始数据；
- Charles同样也能篡改通信的数据：将篡改后的数据重新加密并重新生成摘要并使用之前获得的公钥进行数字签名，替换原本的签名，再传输给服务器；
- 服务器收取到数据，按正常流程解密验证；
- 服务器返回响应数据时，Charles也是类似拦截过程



#### 防抓包

从上文可以知道，抓包主要的原理就是中间人替换了原本的证书；防抓包就可以通过针对证书的校验来实现；
 AFN有封装类似校验证书的功能，接下来主要介绍AFN+SSL Pinning的方式对证书进行校验；

- 获取服务器的HTTPS证书，并把证书加到项目Bundle中;
- AFN代码设置Policy



